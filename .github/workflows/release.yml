name: Create Release Package

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:
        inputs:
            version:
                description: "Version number (e.g., 1.0.1)"
                required: true
                default: "1.0.0"

jobs:
    build-and-release:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Extract version from tag or input
              id: version
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    VERSION="${{ github.event.inputs.version }}"
                  else
                    VERSION=${GITHUB_REF#refs/tags/v}
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "tag=v$VERSION" >> $GITHUB_OUTPUT

            - name: Update version in plugin files
              run: |
                  VERSION="${{ steps.version.outputs.version }}"

                  # Update main plugin file
                  sed -i "s/Version: [0-9]\+\.[0-9]\+\.[0-9]\+/Version: $VERSION/" leadgen-app-form.php
                  sed -i "s/@version [0-9]\+\.[0-9]\+\.[0-9]\+/@version $VERSION/" leadgen-app-form.php

                  # Update other PHP files with @version
                  find includes/ -name "*.php" -exec sed -i "s/@version [0-9]\+\.[0-9]\+\.[0-9]\+/@version $VERSION/" {} \;

                  # Update CSS files
                  find assets/css/ -name "*.css" -exec sed -i "s/@version [0-9]\+\.[0-9]\+\.[0-9]\+/@version $VERSION/" {} \;

                  # Update JS files
                  find assets/js/ -name "*.js" -exec sed -i "s/@version [0-9]\+\.[0-9]\+\.[0-9]\+/@version $VERSION/" {} \;
                  find blocks/ -name "*.js" -exec sed -i "s/@version [0-9]\+\.[0-9]\+\.[0-9]\+/@version $VERSION/" {} \;

            - name: Create distribution package
              id: package
              run: |
                  VERSION="${{ steps.version.outputs.version }}"
                  
                  # Make the script executable
                  chmod +x scripts/create-release-zip.sh
                  
                  # Run the release ZIP creation script
                  ./scripts/create-release-zip.sh "$VERSION"
                  
                  # The script outputs to GITHUB_OUTPUT automatically
                  # Additional logging for GitHub Actions
                  echo "📦 Package created using create-release-zip.sh script"
                  echo "� Version: $VERSION"

            - name: Update RELEASE-NOTES.md
              run: |
                  VERSION="${{ steps.version.outputs.version }}"
                  PACKAGE_SIZE="${{ steps.package.outputs.package_size_kb }}"
                  DATE=$(date +"%B %d, %Y")

                  # Create updated RELEASE-NOTES.md
                  cat > RELEASE-NOTES.md << EOF
                  # LeadGen App Form Plugin - Release v$VERSION

                  ## Package Information
                  - **Plugin Name**: LeadGen App Form Plugin
                  - **Version**: $VERSION
                  - **File**: leadgen-app-form-v$VERSION.zip
                  - **Size**: ~$PACKAGE_SIZE
                  - **Release Date**: $DATE
                  - **License**: GPL v2 or later
                  - **Repository**: https://github.com/SilverAssist/leadgen-app-form

                  ## Installation Package Contents
                  - Main plugin file (\`leadgen-app-form.php\`)
                  - Gutenberg block integration (\`blocks/leadgen-form/\`)
                  - Elementor widget support (\`includes/elementor/\`)
                  - Frontend assets (\`assets/css/\`, \`assets/js/\`)
                  - Documentation ([README.md](README.md), [CHANGELOG.md](CHANGELOG.md))
                  - License file (\`LICENSE\`)

                  ## Installation Methods
                  1. **WordPress Admin Dashboard** (Recommended)
                  2. **Manual FTP Upload**
                  3. **WP-CLI Installation**

                  ## Requirements
                  - WordPress 5.0+
                  - PHP 8.0+

                  ## Features Included
                  - ✅ Gutenberg Block Integration
                  - ✅ Elementor Widget Support
                  - ✅ Responsive Form Handling
                  - ✅ Modern PHP 8.0+ Features
                  - ✅ Translation Ready
                  - ✅ Performance Optimized
                  - ✅ GPL v2 Licensed

                  ## Distribution Channels
                  - **GitHub Releases**: Source code and compiled packages
                  - **Direct Download**: From developer website

                  ## Support & Documentation
                    - **Installation Guide**: [README.md](README.md)
                  - **Change History**: [CHANGELOG.md](CHANGELOG.md)
                  - **Issues**: GitHub Issues tracker

                  ## Installation Instructions
                  See [README.md](README.md) for complete installation guide.
                  EOF

            - name: Generate release notes from CHANGELOG
              id: changelog
              run: |
                  VERSION="${{ steps.version.outputs.version }}"

                  # Extract current version changes from CHANGELOG.md
                  if [ -f "CHANGELOG.md" ]; then
                    echo "Looking for version $VERSION in CHANGELOG.md"
                    
                    # Debug: Show CHANGELOG structure
                    echo "Debug: Lines containing version pattern:"
                    grep -n "\[${VERSION}\]" CHANGELOG.md || echo "No direct match found"
                    
                    # Method 1: Using sed with escaped brackets (most reliable)
                    CHANGES=$(sed -n "/## \\[${VERSION}\\]/,/## \\[/p" CHANGELOG.md | sed '$d' | tail -n +2)
                    
                    if [ -n "$CHANGES" ]; then
                      echo "✅ Found changes with sed method"
                      echo "## Changes in v$VERSION" > release_notes.md
                      echo "$CHANGES" >> release_notes.md
                    else
                      echo "❌ Sed method failed, trying awk method"
                      # Method 2: Using awk (more reliable across different systems)
                      CHANGES_AWK=$(awk "/^## \\[${VERSION}\\]/{flag=1; next} /^## \\[/{flag=0} flag" CHANGELOG.md)
                      
                      if [ -n "$CHANGES_AWK" ]; then
                        echo "✅ Found changes with awk method"
                        echo "## Changes in v$VERSION" > release_notes.md
                        echo "$CHANGES_AWK" >> release_notes.md
                      else
                        echo "❌ Awk method failed, trying grep method"
                        # Method 3: Using grep with line numbers (fallback)
                        LINE_START=$(grep -n "## \\[${VERSION}\\]" CHANGELOG.md | cut -d: -f1)
                        if [ -n "$LINE_START" ]; then
                          echo "✅ Found version at line: $LINE_START"
                          # Extract from start line to next version or end of file
                          CHANGES_GREP=$(tail -n +$((LINE_START + 1)) CHANGELOG.md | sed '/^## \[/q' | sed '$d')
                          if [ -n "$CHANGES_GREP" ]; then
                            echo "✅ Found changes with grep method"
                            echo "## Changes in v$VERSION" > release_notes.md
                            echo "$CHANGES_GREP" >> release_notes.md
                          else
                            echo "❌ All methods failed"
                            echo "## Changes in v$VERSION" > release_notes.md
                            echo "See [CHANGELOG.md](CHANGELOG.md) for detailed changes." >> release_notes.md
                          fi
                        else
                          echo "❌ Version not found in CHANGELOG"
                          echo "## Changes in v$VERSION" > release_notes.md
                          echo "See [CHANGELOG.md](CHANGELOG.md) for detailed changes." >> release_notes.md
                        fi
                      fi
                    fi
                  else
                    echo "CHANGELOG.md not found"
                    echo "## Release v$VERSION" > release_notes.md
                    echo "New release of LeadGen App Form Plugin" >> release_notes.md
                  fi                  # Add package information to release notes
                  cat >> release_notes.md << EOF

                  ## 📦 Package Information
                  - **File**: leadgen-app-form-v$VERSION.zip
                  - **Size**: ~${{ steps.package.outputs.package_size_kb }}
                  - **License**: GPL v2 or later

                  ## 🚀 Installation
                  1. Download the ZIP file below
                  2. Go to WordPress Admin → Plugins → Add New → Upload Plugin
                  3. Choose the downloaded ZIP file and click "Install Now"
                  4. Activate the plugin

                  For detailed installation instructions, see the [README.md](README.md) file.
                  EOF

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.version.outputs.tag }}
                  name: "LeadGen App Form Plugin v${{ steps.version.outputs.version }}"
                  body_path: release_notes.md
                  files: |
                      ${{ steps.package.outputs.zip_path }}
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload package as artifact
              uses: actions/upload-artifact@v4
              with:
                  name: leadgen-app-form-v${{ steps.version.outputs.version }}
                  path: ${{ steps.package.outputs.zip_path }}
                  retention-days: 90

            - name: Summary
              run: |
                  echo "## 🎉 Release Summary" >> $GITHUB_STEP_SUMMARY
                  echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Package**: ${{ steps.package.outputs.package_name }}.zip" >> $GITHUB_STEP_SUMMARY
                  echo "- **Size**: ~${{ steps.package.outputs.package_size_kb }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Release**: [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
